\documentclass[../main.tex]{subfiles}

\begin{document}


We give the instructions for a generic user $u$.

Each round $r$ consists of one or more periods. 
At any point in time, a user $u$ is working on exactly one round and period $(r,p)$.  
A period $(r,p)$ is further broken into steps $(r,p,s)$, with $0\leq s \leq 255$. 
To determine when to act for each step in his current period $(r,p)$, $u$ uses $\timer_u$, 
which is reset whenever $u$ starts a new period.

\subsection{Randomly Elected Committees}

For each step $(r,p,s)$, a committee is elected to vote. Each step $(r,p,s)$ has two associated parameters, which depend only on $s$:
\begin{itemize}
    \item $\textit{\CS}_s$: The expected committee size for that step.
    \item $\textit{\CT}_t$: The committee threshold. A set of votes of total weight $\textit{\CT}_s$ constitutes a \textit{quorum} for step $(r,p,s)$
\end{itemize}
For each $s$, the following list gives the step name and the associated parameters:

\begin{center}
\begin{tabular}{ |c|c|c|c| } 
 \hline
 Step number $s$ & Step Name & $\CS_t$ & $\CT_s$ \\
 \hline
 0 & propose & 20 & N/A \\ 
 1 & soft & 2990 & 2267 \\ 
 2 & cert & 1500 & 1112 \\ 
 3$\leq s \leq$252 & next$_{s-3}$ & 5000 & 3838 \\ 
 253 & late & 500 & 320 \\ 
 254 & redo & 2400 & 1768 \\ 
 255 & down & 6000 & 4560 \\ 
 \hline
\end{tabular}
\end{center}

\subsection{Voting Notation}
\begin{itemize}

\item $\StakeOn_{r-322}$: Total ``online'' stake at round $r-322$.

\item $q^r_s = \frac{\CS_s}{\StakeOn_{r-322}}$.

\item $u$'s $(r,p,s)$-credential: $VRF_u(Q^{r-2},r,p,s)$
If $n\geq 1$ then $u$ is elected to vote.

\item $u$'s $(r,p,s)$-credential weight: The unique integer $n$ that satisfies
\[
\sum_{k=n+1}^\infty \Binomial(b_u^{r-322};q^r_s) < VRF_u(Q^{r-2},r,p,s) \\ 
\leq \sum_{k=n}^\infty \Binomial(b_u^{r-322};q^r_s),
\]
If $n\geq 1$ then $u$ is elected to vote.
    
\item $u$'s $(r,p,0)$-credential value: If $n$ is the credential weight, $h_i$ is the hash of $(credential,i)$, the value is $min_{0\leq i < n}\{h_i\}$
    
\item $u$'s $(r,p,s)$-vote: $\ESIG_u^r(H(B),r,p,s)$; that is, the signature generated by $\ESIG_u^r$.
$H(B)$ is a string in the range of the hash function $H$, and intuitively is the hash of a block $B$.
When the round and period are clear by context, we may use the step name to refer to a vote; for example, $(r,p,2)$-vote may be referred to as a cert-vote.
$\bot$ denotes a specific string of the same length as $H$'s output but is not in the range of $H$. $u$'s vote for $\bot$ is as above but with $H(B)$ replaced by $\bot$.
    
\item $(r,p,s)$-quorum: A set of $CT_s$ $(r,p,s)$-votes for the same value.
\end{itemize}

\subsection{Timing Parameters}
\label{subsection:TimingParameters}

\begin{itemize}

\item $\lambda$: intuitively corresponds to the time that it takes a small message (e.g. a vote) to propagate in good network conditions.

\item $\lambda_{0min}$: corresponds to the minimum amount of time the dynamic algorithm must allow for a small message (e.g. a vote) to propagate under ideal network conditions for period $0$, failing back to $\lambda$ in future periods if calculated duration was not sufficient to make progress.

\item $\lambda_{0max}$: corresponds to the maximum amount of time the dynamic algorithm will allow for a small message (e.g. a vote) to propagate under ideal network conditions for period $0$, failing back to $\lambda$ in future periods if the calculated duration was not sufficient to make progress.

\item $\Lambda$: intuitively corresponds to the time it takes a big message (e.g. a block) to propagate in reasonable network conditions.

\item $\Lambda_0$: intuitively corresponds to the time it takes a big message (e.g. a block) to propagate in good network conditions for period $0$, failing back to $\Lambda$ in future periods if $\Lambda_0$ was not sufficient to propagate the block.

\item $\lambda_f$: the frequency at which the fast partition recovery steps are repeated.

\end{itemize}

\subsection{The Protocol Instructions}
User $u$ starts round $r$ period $0$ when he first sees a cert-quorum from round $r-1$ for some $H(B^{r-1})$ and the block $B^{r-1}$. 
While in period $(r,p)$, if $u$ sees a next-quorum for period $p' \geq p$, then $u$ starts period $p'+1$.

Whenever $u$ starts a new period (including when he starts a new round), he resets $timer_u$, which is used to make decisions on when to vote for each step.

\subsubsection{Period $(r,p)$ voting instructions}

When user $u$ starts period $(r,p)$, he finishes all previous periods and resets $timer_u$ to $0$.

In the step instructions, any message $u$ propagates is accompanied by $u$'s signature using his ephemeral key $\ESK^r_u$ and
$u$'s credential for that step.

We describe the protocol steps. To simplify the exposition, certain implementation details are omitted.

\begin{description}

\item[{\sc Step 0:}] [Proposal]
When $timer_u = 0$:
\begin{itemize}

\item[--] If $p = 0$ or if $p>0$ and $u$ has received a next-quorum for $\bot$ from period $(r,p-1)$], then $u$ assembles a new block proposal $B_u$, then propagates $B_u$ and $H(B_u)$ as separate messages.

\item[--] Otherwise, $p>0$ and $u$ has received a next-quorum for $v=H(B') \neq \bot$ from period $(r,p-1)$, and $u$ propagates $v$;

\end{itemize}

\item[{\sc Step 1:}] [Filtering] When $\timer_u = 2\lambda$ if $p>0$, or $\timer_u = 2\lambda_0$ if $p=0$:
\begin{itemize}

\item[--] If $p=0$ or if $p>0$ and $u$ has received a next-quorum for $\bot$ from period $(r,p-1)$,
then $u$ selects from the proposals it has received for this period (if any) the proposal $v$ whose proposer has the minimum credential, 
and soft-votes $v$ 
[unless $v$ was a proposal from an earlier period and $u$ has not received a next-quorum for $v$];

\item[--] Otherwise, $p>0$ and $u$ has received a next-quorum for $v=H(B') \neq \bot$ from period $(r,p-1)$, and $u$ soft-votes $v$.
\end{itemize}

\item[{\sc Step 2:}] [Certifying] While $timer_u\in (2\lambda, \max\{4\lambda,\Lambda\})$:

\begin{itemize}
\item[--] If $u$ receives a period $(r,p)$ soft-quorum for some value $v$ and a valid block $B$ with $H(B)=v$, then $i$ cert-votes $v$.
\end{itemize}

\item[{\sc Step $s \in [3,252]$:}] [Recovery]
When $timer_u = \max\{4\lambda,\Lambda\}$ (when $s=3$) or $\max\{4\lambda,\Lambda\} + 2^{s-3} \lambda + r$ (when $4 \leq s \leq 252$), where $r \in [0,2^{s-3}\lambda]$ is sampled uniformly at random:

\begin{itemize}

\item[--] If $u$ has seen a valid block $B$ and a $(r,p)$-soft-quorum for $H(B)$ then $u$ next-votes $H(B)$;

\item[--] Otherwise, if $p>0$ and $u$ has received a next-quorum for $\bot$ from period $(r,p-1)$, then $u$ next-votes $\bot$.

\item[--] Otherwise, $u$ has received a next-quorum for $v=H(B') \neq \bot$ from period $(r,p-1)$, and $u$ next-votes $v$.

\end{itemize}


\item[{\sc Step $s \in [253,255]$:}] [Fast recovery] When $\timer_u = k\lambda_f + t$ for any positive integer $k$ and $t \in [0,\lambda_f]$, where $t$ is sampled uniformly at random:

\begin{itemize}

\item[--] If $u$ has seen a valid block $B$ and a $(r,p)$-soft-quorum for $H(B)$ then $u$ late-votes $H(B)$ [step 253];

\item[--] Otherwise, if $p>0$ and $u$ has received a next-quorum for $\bot$ from period $(r,p-1)$, then $u$ down-votes $\bot$ [step 255];

\item[--] Otherwise, $u$ has received a next-quorum for $v=H(B') \neq \bot$ from period $(r,p-1)$, and $u$ redo-votes $v$ [step 254].

\end{itemize}
\end{description}

\subsection{The seed} \label{subsection:SeedFormula}
At $B^0$, $Q^0 = H(S^0)$.\\
Recall that $S^{-r}=S^0$ and $Q^{-r}=Q^0$. A valid block proposal for period $(r,p)$ and proposer $u$, has a seed $Q^r$ defined as follows for $r>0$:
\begin{tabbing}
If $r \equiv 0 \bmod 160$ or $r \equiv 1 \bmod 160$:\\
\hspace{5mm}If $p=0$:\\
\hspace{10mm}$Q^r=VRF_u(Q^{r-2},H(B^{r-160}))$\\
\hspace{5mm}Else:\\
\hspace{10mm}$Q^r=H(Q^{r-2},H(B^{r-160}))$\\
Else:\\
\hspace{5mm}If $p=0$:\\
\hspace{10mm}$Q^r=VRF_u(Q^{r-2})$\\
\hspace{5mm}Else:\\
\hspace{10mm}$Q^r=H(Q^{r-2})$\\
\end{tabbing}

\subsection{Safety Properties}
\label{subsection:SafetyConditions}

Here we list a set of properties of the protocol, which imply safety. 
\iffalse
These will be further discussed in Section~\ref{section:ParameterComputations}.
\fi
Each property below refers to quorums and steps within a single period; we list the associated steps for each period. 
Conditions 4 and 5 are similar, we list them separately to decouple their associated steps.
\begin{enumerate}

\item Malicious users cannot, by themselves, generate a quorum for any step.\\
Associated steps: $[1,255]$

\item No two distinct soft-quorums are generated.\\
Associated steps: $1$

\item If there is a cert-quorum, then there is no down-quorum or next-quorum for $\bot$.\\
Associated steps: $[2,252],255$

\item If there is a soft-quorum on $v$, there is no next-quorum for $v' \notin \{v,\bot\}$.\\
Associated steps: $1,[3,252]$

\item If there is a soft-quorum on $v$, there is no redo-quorum for $v' \neq v$.\\
Associated steps: $1,254$

\end{enumerate}

\end{document}
